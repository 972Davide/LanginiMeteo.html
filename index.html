<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Langini Meteo ‚Äì Dashboard V7.8</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- SunCalc per alba/tramonto -->
  <script src="https://unpkg.com/suncalc@1.9.0/suncalc.js"></script>

  <style>
    :root {
      --bg-top: #021b3c;
      --bg-bottom: #034f9a;
      --card-bg: #f8fbff;
      --card-border: #d0e0ff;
      --text-main: #0b1b3a;
      --text-muted: #6b7a99;
      --accent: #ffc107;
      --good: #00c853;
      --moderate: #ffca28;
      --bad: #ff7043;
      --danger: #d50000;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        Roboto, sans-serif;
      background: linear-gradient(to bottom, var(--bg-top), var(--bg-bottom));
      color: #fff;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .sky {
      position: relative;
      flex: 1;
      background: linear-gradient(to bottom, #01224f, #0760c5);
      transition: background 0.8s ease;
    }

    .sky.night {
      background: radial-gradient(circle at 20% 0%, #243b6b, #020520 60%);
    }

    .stars {
      position: absolute;
      inset: 0;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.8s ease;
      background-image: radial-gradient(circle, rgba(255,255,255,0.8) 1px, transparent 1px);
      background-size: 3px 3px;
      mix-blend-mode: screen;
    }

    .sky.night .stars {
      opacity: 0.35;
    }

    .content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
      position: relative;
      z-index: 2;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    header {
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: center;
      text-align: center;
    }

    header h1 {
      font-size: 1.5rem;
      font-weight: 700;
    }

    header h1 span.version {
      font-size: 0.95rem;
      opacity: 0.7;
      margin-left: 4px;
    }

    header .subtitle {
      font-size: 0.85rem;
      opacity: 0.9;
    }

    .status-bar {
      margin-top: 4px;
      font-size: 0.85rem;
      background: rgba(0, 0, 0, 0.25);
      padding: 6px 12px;
      border-radius: 999px;
      display: inline-flex;
      gap: 10px;
      align-items: center;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #0f0;
      box-shadow: 0 0 8px rgba(0, 255, 0, 0.8);
    }

    .quality-banner {
      margin: 4px auto 0;
      padding: 10px 24px;
      border-radius: 999px;
      background: #ffc400;
      color: #202020;
      font-weight: 600;
      font-size: 0.95rem;
      box-shadow: 0 0 20px rgba(255, 196, 0, 0.6);
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .quality-banner.good {
      background: #00e676;
      box-shadow: 0 0 20px rgba(0, 230, 118, 0.6);
    }

    .quality-banner.moderate {
      background: #ffeb3b;
      box-shadow: 0 0 20px rgba(255, 235, 59, 0.6);
    }

    .quality-banner.bad {
      background: #ff9100;
      box-shadow: 0 0 20px rgba(255, 145, 0, 0.6);
    }

    .quality-banner.very-bad {
      background: #ff1744;
      box-shadow: 0 0 20px rgba(255, 23, 68, 0.7);
      color: #fff;
    }

    .quality-banner span.icon {
      font-size: 1.1rem;
    }

    .sun-times {
      margin: 6px auto 0;
      padding: 6px 14px;
      border-radius: 12px;
      background: rgba(0, 0, 0, 0.25);
      font-size: 0.85rem;
      display: inline-flex;
      gap: 12px;
      align-items: center;
    }

    .sun-times span {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .cards {
      margin-top: 24px;
      display: grid;
      grid-template-columns: repeat(6, minmax(0, 1fr));
      gap: 14px;
    }

    @media (max-width: 1100px) {
      .cards {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
    }

    @media (max-width: 720px) {
      .cards {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 480px) {
      .cards {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: var(--card-bg);
      color: var(--text-main);
      border-radius: 16px;
      padding: 14px 14px 12px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
      border: 1px solid var(--card-border);
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-height: 150px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.9rem;
      font-weight: 600;
    }

    .card-header span.icon {
      font-size: 1.1rem;
    }

    .gauge {
      position: relative;
      height: 80px;
      margin-top: 4px;
    }

    .gauge-track {
      position: absolute;
      inset: auto 0 0;
      height: 16px;
      border-radius: 999px;
      background: #eceff4;
      overflow: hidden;
    }

    .gauge-fill {
      height: 100%;
      width: 0%;
      border-radius: inherit;
      background: linear-gradient(90deg, #ffb300, #ff6d00);
      transition: width 0.4s ease-out;
    }

    .value {
      font-size: 1.4rem;
      font-weight: 700;
      margin-top: 8px;
    }

    .value-unit {
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .card-footer {
      margin-top: auto;
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    .rain-status {
      font-size: 1.3rem;
      margin-top: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      font-weight: 600;
    }

    .rain-status span.icon {
      font-size: 1.4rem;
    }

    .rain-status.wet {
      color: #1565c0;
    }

    .rain-status.dry {
      color: #f57c00;
    }

    .wind-label {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 2px;
    }
  </style>
</head>
<body>
  <div class="sky" id="sky">
    <div class="stars"></div>
    <div class="content">
      <header>
        <h1>üåü Langini Meteo ‚Äì Dashboard <span class="version">V7.8</span></h1>
        <div class="subtitle">Meteo + Vento + Pioggia</div>

        <div class="status-bar" id="statusBar">
          <span class="status-dot"></span>
          <span id="statusText">Aggiornamento in corso‚Ä¶</span>
        </div>

        <div class="quality-banner moderate" id="qualityBanner">
          <span class="icon">‚ö†Ô∏è</span>
          <span id="qualityLabel">Qualit√† aria: --</span>
        </div>

        <div class="sun-times" id="sunTimes">
          <span>üåÖ <strong>Alba:</strong> --:--</span>
          <span>üåá <strong>Tramonto:</strong> --:--</span>
        </div>
      </header>

      <section class="cards">
        <!-- Pressione -->
        <article class="card">
          <div class="card-header">
            <span>Pressione (hPa)</span>
            <span class="icon">üíß</span>
          </div>
          <div class="gauge">
            <div class="gauge-track">
              <div class="gauge-fill" id="gaugePressure"></div>
            </div>
          </div>
          <div class="value">
            <span id="pressureValue">0</span>
          </div>
          <div class="value-unit">hPa</div>
          <div class="card-footer">Media oraria: <span id="pressureAvg">0.0</span></div>
        </article>

        <!-- Temperatura -->
        <article class="card">
          <div class="card-header">
            <span>Temperatura (¬∞C)</span>
            <span class="icon">üå°Ô∏è</span>
          </div>
          <div class="gauge">
            <div class="gauge-track">
              <div class="gauge-fill" id="gaugeTemp"></div>
            </div>
          </div>
          <div class="value">
            <span id="tempValue">0</span>
          </div>
          <div class="value-unit">¬∞C</div>
          <div class="card-footer">Media oraria: <span id="tempAvg">0.0</span></div>
        </article>

        <!-- Umidit√† -->
        <article class="card">
          <div class="card-header">
            <span>Umidit√† (%)</span>
            <span class="icon">üíß</span>
          </div>
          <div class="gauge">
            <div class="gauge-track">
              <div class="gauge-fill" id="gaugeHum"></div>
            </div>
          </div>
          <div class="value">
            <span id="humValue">0</span>
          </div>
          <div class="value-unit">% UR</div>
          <div class="card-footer">Media oraria: <span id="humAvg">0.0</span></div>
        </article>

        <!-- Qualit√† Aria -->
        <article class="card">
          <div class="card-header">
            <span>Qualit√† Aria (MQ135)</span>
            <span class="icon">üå±</span>
          </div>
          <div class="gauge">
            <div class="gauge-track">
              <div class="gauge-fill" id="gaugeAQ"></div>
            </div>
          </div>
          <div class="value">
            <span id="aqValue">0</span>
          </div>
          <div class="value-unit">AQI</div>
          <div class="card-footer">Media oraria: <span id="aqAvg">0.0</span></div>
        </article>

        <!-- Vento -->
        <article class="card">
          <div class="card-header">
            <span>Vento (km/h)</span>
            <span class="icon">üí®</span>
          </div>
          <div class="gauge">
            <div class="gauge-track">
              <div class="gauge-fill" id="gaugeWind"></div>
            </div>
          </div>
          <div class="value">
            <span id="windValue">0</span>
          </div>
          <div class="value-unit">km/h</div>
          <div class="card-footer">
            Media: <span id="windAvg">0.0</span>
          </div>
        </article>

        <!-- Pioggia -->
        <article class="card">
          <div class="card-header">
            <span>Pioggia</span>
            <span class="icon">üåßÔ∏è</span>
          </div>
          <div class="rain-status dry" id="rainStatus">
            <span class="icon">üåû</span><span id="rainText">Asciutto</span>
          </div>
          <div class="card-footer">
            Ultimo rilevamento: <span id="rainTime">--:--:--</span>
          </div>
        </article>
      </section>
    </div>
  </div>

  <script>
    // ====================================
    //  CONFIG
    // ====================================
    const METEO_CHANNEL = 3149218;   // pressione, temp, umidit√†, MQ135
    const WIND_CHANNEL  = 2956240;   // vento, pioggia

    const LAT = 45.7525;
    const LON = 8.8975;

    // ====================================
    //  FUNZIONI UTILITARIE
    // ====================================
    function toNumber(v, fallback = 0) {
      const n = parseFloat(v);
      return isNaN(n) ? fallback : n;
    }

    function averageField(feeds, fieldName) {
      if (!feeds || !feeds.length) return 0;
      let sum = 0;
      let count = 0;
      for (const f of feeds) {
        const v = toNumber(f[fieldName], NaN);
        if (!isNaN(v)) {
          sum += v;
          count++;
        }
      }
      return count ? sum / count : 0;
    }

    function formatTime(dateStr) {
      if (!dateStr) return "--:--:--";
      const d = new Date(dateStr);
      return d.toLocaleTimeString("it-IT", {
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit",
      });
    }

    function clamp(val, min, max) {
      return Math.min(max, Math.max(min, val));
    }

    function classifyAir(aqi) {
      if (aqi <= 50) return { label: "Aria eccellente", cls: "good" };
      if (aqi <= 100) return { label: "Aria buona", cls: "good" };
      if (aqi <= 150) return { label: "Qualit√† moderata", cls: "moderate" };
      if (aqi <= 200) return { label: "Aria scadente", cls: "bad" };
      return { label: "Aria pessima", cls: "very-bad" };
    }

    // ====================================
    //  ALBA / TRAMONTO CON SUNCALC
    // ====================================
    function updateSunTimes() {
      try {
        const now = new Date();
        const times = SunCalc.getTimes(now, LAT, LON);
        const sunrise = times.sunrise;
        const sunset = times.sunset;

        const sunriseStr = sunrise.toLocaleTimeString("it-IT", {
          hour: "2-digit",
          minute: "2-digit",
        });
        const sunsetStr = sunset.toLocaleTimeString("it-IT", {
          hour: "2-digit",
          minute: "2-digit",
        });

        const sunTimesEl = document.getElementById("sunTimes");
        sunTimesEl.innerHTML =
          `<span>üåÖ <strong>Alba:</strong> ${sunriseStr}</span>` +
          `<span>üåá <strong>Tramonto:</strong> ${sunsetStr}</span>`;

        // Aggiorna cielo giorno/notte
        const sky = document.getElementById("sky");
        if (now < sunrise || now > sunset) {
          sky.classList.add("night");
        } else {
          sky.classList.remove("night");
        }
      } catch (e) {
        console.error("Errore SunCalc:", e);
      }
    }

    // ====================================
    //  FETCH & AGGIORNAMENTO DASHBOARD
    // ====================================
    async function fetchJson(url) {
      const res = await fetch(url);
      if (!res.ok) throw new Error("HTTP " + res.status);
      return res.json();
    }

    async function updateDashboard() {
      try {
        const [meteoData, windData] = await Promise.all([
          fetchJson(
            `https://api.thingspeak.com/channels/${METEO_CHANNEL}/feeds.json?results=60`
          ),
          fetchJson(
            `https://api.thingspeak.com/channels/${WIND_CHANNEL}/feeds.json?results=60`
          ),
        ]);

        const feedsMeteo = meteoData.feeds || [];
        const feedsWind = windData.feeds || [];

        const lastMeteo = feedsMeteo[feedsMeteo.length - 1] || {};
        const lastWind = feedsWind[feedsWind.length - 1] || {};

        // ---- METEO ----
        const pressure = toNumber(lastMeteo.field1);
        const temp = toNumber(lastMeteo.field2);
        const hum = toNumber(lastMeteo.field3);
        const aqi = toNumber(lastMeteo.field4);

        document.getElementById("pressureValue").textContent =
          pressure.toFixed(0);
        document.getElementById("tempValue").textContent = temp.toFixed(0);
        document.getElementById("humValue").textContent = hum.toFixed(0);
        document.getElementById("aqValue").textContent = aqi.toFixed(0);

        document.getElementById("pressureAvg").textContent =
          averageField(feedsMeteo, "field1").toFixed(1);
        document.getElementById("tempAvg").textContent =
          averageField(feedsMeteo, "field2").toFixed(1);
        document.getElementById("humAvg").textContent =
          averageField(feedsMeteo, "field3").toFixed(1);
        document.getElementById("aqAvg").textContent =
          averageField(feedsMeteo, "field4").toFixed(1);

        // Gauge percentuali
        const pressurePct = clamp(((pressure - 950) / (1050 - 950)) * 100, 0, 100);
        const tempPct = clamp(((temp + 10) / (50 + 10)) * 100, 0, 100);
        const humPct = clamp(hum, 0, 100);
        const aqPct = clamp((aqi / 500) * 100, 0, 100);

        document.getElementById("gaugePressure").style.width =
          pressurePct + "%";
        document.getElementById("gaugeTemp").style.width = tempPct + "%";
        document.getElementById("gaugeHum").style.width = humPct + "%";
        document.getElementById("gaugeAQ").style.width = aqPct + "%";

        // ---- VENTO + PIOGGIA ----
        const wind = toNumber(lastWind.field1);
        const rainFlag = toNumber(lastWind.field2);

        document.getElementById("windValue").textContent = wind.toFixed(0);
        document.getElementById("windAvg").textContent =
          averageField(feedsWind, "field1").toFixed(1);

        const windPct = clamp((wind / 120) * 100, 0, 100);
        document.getElementById("gaugeWind").style.width = windPct + "%";

        const rainStatusEl = document.getElementById("rainStatus");
        const rainTextEl = document.getElementById("rainText");
        const rainTimeEl = document.getElementById("rainTime");

        if (rainFlag >= 1) {
          rainStatusEl.classList.remove("dry");
          rainStatusEl.classList.add("wet");
          rainStatusEl.innerHTML = `<span class="icon">üåßÔ∏è</span><span id="rainText">Pioggia</span>`;
        } else {
          rainStatusEl.classList.remove("wet");
          rainStatusEl.classList.add("dry");
          rainStatusEl.innerHTML = `<span class="icon">üåû</span><span id="rainText">Asciutto</span>`;
        }
        rainTimeEl.textContent = formatTime(lastWind.created_at);

        // ---- STATUS BAR ----
        const lastTime = lastMeteo.created_at || lastWind.created_at;
        const timeStr = formatTime(lastTime);
        const statusText = document.getElementById("statusText");
        statusText.textContent = `Aggiornato: ${timeStr} ‚Ä¢ Vento: ${wind.toFixed(
          1
        )} km/h ‚Ä¢ Stato: ${
          rainFlag >= 1 ? "Pioggia" : "Asciutto"
        }`;

        // ---- QUALIT√Ä ARIA BANNER ----
        const qInfo = classifyAir(aqi);
        const qBanner = document.getElementById("qualityBanner");
        qBanner.classList.remove("good", "moderate", "bad", "very-bad");
        qBanner.classList.add(qInfo.cls);
        qBanner.querySelector("#qualityLabel").textContent = qInfo.label;

      } catch (err) {
        console.error("Errore aggiornamento dashboard:", err);
        document.getElementById("statusText").textContent =
          "Errore lettura dati ThingSpeak";
      }
    }

    // ====================================
    //  AVVIO
    // ====================================
    updateSunTimes();
    updateDashboard();
    setInterval(updateDashboard, 20000);  // ogni 20 secondi
    setInterval(updateSunTimes, 5 * 60 * 1000); // ogni 5 minuti
  </script>
</body>
</html>

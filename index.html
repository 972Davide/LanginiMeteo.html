<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Langini Meteo Online</title>

<!-- Librerie -->
<script src="https://cdn.jsdelivr.net/npm/raphael@2.3.0/raphael.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/justgage@1.5.0/justgage.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/suncalc@1.9.0/suncalc.min.js"></script>

<style>
:root{
  --sky-day-1:#7ec9ff;--sky-day-2:#2b77d0;
  --sky-tw-1:#ffa452;--sky-tw-2:#3456a0;
  --sky-night-1:#001028;--sky-night-2:#002a4f;
}
html,body{
  margin:0;padding:0;height:100%;
  font-family:Arial,Helvetica,sans-serif;
  color:#fff;text-align:center;
  background:var(--sky-night-1);
}
header{
  background:rgba(153,152,168,.9);
  padding:12px 0;font-weight:700;font-size:1.6em;
  box-shadow:0 2px 6px rgba(0,0,0,.3)
}
#sky{
  position:relative;height:45vh;min-height:260px;
  overflow:hidden;transition:background 1.5s
}
#stars{position:absolute;inset:0;pointer-events:none}
.star{
  position:absolute;width:2px;height:2px;
  background:#fff;border-radius:50%;
  opacity:0;animation:twinkle 4s infinite
}
@keyframes twinkle{0%,100%{opacity:0}50%{opacity:1}}

.body{
  position:absolute;width:130px;height:130px;border-radius:50%;
  top:50%;left:-20%;transform:translate(-50%,-50%);
  will-change:transform,opacity
}
#sun{
  background:radial-gradient(circle at 30% 30%,#fff68d 10%,#ffb400 60%,#ff6600 100%);
  box-shadow:0 0 60px 18px rgba(255,200,50,.6)
}
#moon{
  background:radial-gradient(circle at 40% 40%,#e0f0ff 25%,#7fa9ff 100%);
  box-shadow:0 0 40px 12px rgba(120,160,255,.28);
  opacity:.95
}

#astroCountdown{
  background:rgba(0,0,0,0.35);
  padding:10px 20px;
  border-radius:12px;
  display:inline-block;
  font-size:1.2em;
  font-weight:600;
  margin:10px auto 0;
  box-shadow:0 0 10px rgba(0,0,0,0.3);
}

#gauges{
  display:flex;
  flex-wrap:wrap;
  justify-content:center;
  gap:25px;
  padding:15px 0 60px;
  background:linear-gradient(to bottom,#001a33,#000c1a);
  border-top:3px solid #0a66cc;
}

/* G A U G E  senza sfondo */
.gaugeBox{
  background:none;
  border:none;
  border-radius:0;
  box-shadow:none;
  width:270px;
  height:260px;
  padding:10px;
  color:#fff;
}
.label{font-size:1.15em;font-weight:700;margin-top:6px;color:#a8d8ff}
.value{font-size:1.1em;font-weight:700;color:#fff}
.mean{font-size:.95em;color:#aad}
a.btn{
  color:#fff;background:#0a66cc;
  padding:10px 18px;border-radius:10px;
  text-decoration:none;font-weight:700;
  margin:16px auto 0;display:inline-block;
  transition:.3s;
}
a.btn:hover{background:#1795ff}
footer{
  font-size:.9em;color:#a9c9ff;background:#001b3a;padding:10px
}
@media (max-width:768px){.gaugeBox{width:44vw;min-width:260px}}
</style>
</head>
<body>
<header>üå§Ô∏è Langini Meteo Online</header>

<div id="sky">
  <div id="stars"></div>
  <div id="sun" class="body" style="display:none;"></div>
  <div id="moon" class="body" style="display:none;"></div>
</div>

<!-- üîÜ Riga conto alla rovescia -->
<div id="astroCountdown">...</div>

<div id="gauges">
  <div class="gaugeBox">
    <div id="g1" style="height:160px"></div>
    <div class="label">Pressione (hPa)</div>
    <div class="value">Live: <span id="v1">--</span></div>
    <div class="mean">Media oraria: <span id="m1">--</span></div>
  </div>
  <div class="gaugeBox">
    <div id="g2" style="height:160px"></div>
    <div class="label">Temperatura (¬∞C)</div>
    <div class="value">Live: <span id="v2">--</span></div>
    <div class="mean">Media oraria: <span id="m2">--</span></div>
  </div>
  <div class="gaugeBox">
    <div id="g3" style="height:160px"></div>
    <div class="label">Umidit√† (%)</div>
    <div class="value">Live: <span id="v3">--</span></div>
    <div class="mean">Media oraria: <span id="m3">--</span></div>
  </div>
  <div class="gaugeBox">
    <div id="g4" style="height:160px"></div>
    <div class="label">Qualit√† Aria (MQ135)</div>
    <div class="value">Live: <span id="v4">--</span></div>
    <div class="mean">Media oraria: <span id="m4">--</span></div>
  </div>
</div>

<a href="grafici.html" class="btn">üìä Vedi Grafici Dettagliati</a>

<footer>
Aggiornamento automatico ogni 30 s ‚Ä¢ ¬© 2025 Langini Meteo ‚Ä¢ ThingSpeak API live
</footer>

<script>
const LAT=41.8933,LON=12.4829;
const CHANNEL_ID=3149218,API_KEY="4EGG4DXUFDU6FUGN";

// stelle
(function makeStars(){
  const N=80,box=document.getElementById('stars');
  for(let i=0;i<N;i++){
    const s=document.createElement('div');
    s.className='star';
    s.style.left=(Math.random()*100)+'%';
    s.style.top=(Math.random()*100)+'%';
    s.style.animationDelay=(Math.random()*4)+'s';
    s.style.opacity=(0.4+Math.random()*0.6).toFixed(2);
    box.appendChild(s);
  }
})();

let timesToday=null,timesTomorrow=null;
function computeTimes(){
  const now=new Date();
  const d0=new Date(now.getFullYear(),now.getMonth(),now.getDate());
  const d1=new Date(d0.getTime()+86400000);
  timesToday=SunCalc.getTimes(d0,LAT,LON);
  timesTomorrow=SunCalc.getTimes(d1,LAT,LON);
}
computeTimes();
setInterval(()=>{
  let n=new Date();
  if(n.getHours()===0&&n.getMinutes()<2)computeTimes();
},60000);

function lerp(a,b,t){return a+(b-a)*t}
function clamp01(x){return Math.max(0,Math.min(1,x))}
function timeProgress(t1,t2,n){return clamp01((n-t1)/(t2-t1))}
function mixColor(c1,c2,p){
  const r=Math.round(lerp(c1[0],c2[0],p)).toString(16).padStart(2,'0');
  const g=Math.round(lerp(c1[1],c2[1],p)).toString(16).padStart(2,'0');
  const b=Math.round(lerp(c1[2],c2[2],p)).toString(16).padStart(2,'0');
  return r+g+b;
}

function updateSky(){
  const now=new Date();
  const sunrise=timesToday.sunrise;
  const sunset=timesToday.sunset;
  const nextSunrise=timesTomorrow.sunrise;
  const isDay=(now>=sunrise&&now<sunset);
  const sky=document.getElementById('sky');

  // sfondo
  const TW=45*60000;
  let bg1,bg2;
  if(now>=new Date(sunrise-TW)&&now<new Date(sunrise+TW)){
    const p=timeProgress(sunrise-TW,sunrise+TW,now);
    bg1=`#${mixColor([0x00,0x10,0x28],[0xff,0xa4,0x52],p)}`;
    bg2=`#${mixColor([0x00,0x2a,0x4f],[0x34,0x56,0xa0],p)}`;
  }else if(now>=new Date(sunset-TW)&&now<new Date(sunset+TW)){
    const p=timeProgress(sunset-TW,sunset+TW,now);
    bg1=`#${mixColor([0x7e,0xc9,0xff],[0xff,0xa4,0x52],p)}`;
    bg2=`#${mixColor([0x2b,0x77,0xd0],[0x34,0x56,a0],p)}`;
  }else if(isDay){bg1='7ec9ff';bg2='2b77d0';}
  else{bg1='001028';bg2='002a4f';}
  sky.style.background=`linear-gradient(to bottom,#${bg1},#${bg2})`;

  // sole e luna
  const sun=document.getElementById('sun');
  const moon=document.getElementById('moon');
  const stars=document.getElementById('stars');
  if(isDay){
    sun.style.display='block';moon.style.display='none';stars.style.display='none';
    const p=timeProgress(sunrise,sunset,now);
    const x=lerp(-10,110,p),y=60-40*Math.sin(Math.PI*p);
    sun.style.left=x+'%';sun.style.top=y+'%';
  }else{
    sun.style.display='none';moon.style.display='block';stars.style.display='block';
    const moonStart=sunset,moonEnd=nextSunrise;
    const p=timeProgress(moonStart,moonEnd,now);
    const x=lerp(-10,110,p),y=70-30*Math.sin(Math.PI*p);
    moon.style.left=x+'%';moon.style.top=y+'%';
  }

  // conto alla rovescia
  const out=document.getElementById('astroCountdown');
  let target,label,icon;
  if(isDay){target=sunset;label="al tramonto";icon="‚òÄÔ∏è";}
  else{target=sunrise>now?sunrise:nextSunrise;label="all‚Äôalba";icon="üåô";}
  const diff=target-now;
  const h=Math.floor(diff/3600000);
  const m=Math.floor((diff%3600000)/60000);
  out.innerHTML=`${icon} ${isDay?"Tramonto":"Alba"} tra <b>${h}h ${m}min</b>`;
}
updateSky();
setInterval(updateSky,60000);

// gauge
const g1=new JustGage({id:"g1",value:0,min:950,max:1050,gaugeWidthScale:.8,counter:true,pointer:true,levelColors:["#00ccff","#00ff99","#ffcc00","#ff3300"]});
const g2=new JustGage({id:"g2",value:0,min:-10,max:50,gaugeWidthScale:.8,counter:true,pointer:true,levelColors:["#3399ff","#00ccff","#ffcc00","#ff3300"]});
const g3=new JustGage({id:"g3",value:0,min:0,max:100,gaugeWidthScale:.8,counter:true,pointer:true,levelColors:["#ff3300","#ffcc00","#00cc66","#0099ff"]});
const g4=new JustGage({id:"g4",value:0,min:0,max:500,gaugeWidthScale:.8,counter:true,pointer:true,levelColors:["#00cc66","#ffcc00","#ff6600","#ff0000"]});

async function updateGauges(){
  try{
    const res=await fetch(`https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds.json?api_key=${API_KEY}&results=60`);
    const data=await res.json();
    if(!data.feeds||!data.feeds.length)return;
    const f=data.feeds.map(x=>({f1:+x.field1,f2:+x.field2,f3:+x.field3,f4:+x.field4}));
    const last=f[f.length-1];
    const mean=a=>(a.reduce((s,v)=>s+(isFinite(v)?v:0),0)/a.filter(x=>isFinite(x)).length).toFixed(1);
    g1.refresh(last.f1);g2.refresh(last.f2);g3.refresh(last.f3);g4.refresh(last.f4);
    document.getElementById("v1").textContent=last.f1.toFixed(1);
    document.getElementById("v2").textContent=last.f2.toFixed(1);
    document.getElementById("v3").textContent=last.f3.toFixed(1);
    document.getElementById("v4").textContent=last.f4.toFixed(1);
    document.getElementById("m1").textContent=mean(f.map(x=>x.f1));
    document.getElementById("m2").textContent=mean(f.map(x=>x.f2));
    document.getElementById("m3").textContent=mean(f.map(x=>x.f3));
    document.getElementById("m4").textContent=mean(f.map(x=>x.f4));
  }catch(e){console.error(e);}
}
updateGauges();
setInterval(updateGauges,30000);
</script>
</body>
</html>

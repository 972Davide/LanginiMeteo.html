<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Langini Meteo ‚Äì Dashboard V13 (ThingSpeak + Vento Pro)</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/raphael@2.3.0/raphael.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/justgage@1.5.0/justgage.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/suncalc@1.9.0/suncalc.min.js"></script>

<style>
body{
  margin:0;font-family:"Poppins",sans-serif;color:white;text-align:center;
  overflow-x:hidden;transition:background 2s;
  background:linear-gradient(to bottom,#001b3a 0%,#004a8d 40%,#0066b2 100%);
}
header{
  background:rgba(0,0,30,0.7);
  color:#fff;
  padding:16px 0 10px;
  font-weight:600;
  box-shadow:0 2px 10px rgba(0,0,0,0.25);
  text-align:center;
}
header .mainTitle{
  font-size:1.7em;
  display:inline-block;
  vertical-align:middle;
}
header .subTitle{
  font-size:1.05em;
  font-weight:400;
  color:#a9c9ff;
  margin-left:12px;
  vertical-align:middle;
  opacity:0.9;
}
#statusBar{
  background:rgba(0,0,0,0.15);
  font-size:0.93em;
  color:#a9c9ff;
  padding:6px;
  transition:color 0.5s;
}

/* CIELO */
#sky{position:relative;height:46vh;overflow:hidden;border-bottom:4px solid #048;}
#stars{position:absolute;inset:0;opacity:0;z-index:1;}
.star{position:absolute;width:2px;height:2px;background:#fff;border-radius:50%;animation:twinkle 4s infinite;}
@keyframes twinkle{0%,100%{opacity:0.2}50%{opacity:1}}
#sun,#moon{
  position:absolute;top:53%;left:50%;width:110px;height:110px;border-radius:50%;
  transform:translate(-50%,-50%);transition:left 1.5s,top 1.5s,opacity 2s;
  z-index:2;opacity:0;
}
#sun{
  background:radial-gradient(circle,#fff600 20%,#ffcc00 70%,#ffaa00 100%);
  box-shadow:0 0 40px 10px #ffcc00;
}
#moon{
  background:radial-gradient(circle at 31% 32%,#f0f0f0 40%,#bdbdbd 100%);
  box-shadow:0 0 25px 5px #ccc;
}
.cloud{
  position:absolute;background:rgba(255,255,255,0.9);
  border-radius:50%;
  box-shadow:-40px 10px 60px rgba(255,255,255,0.6),
              60px 20px 80px rgba(255,255,255,0.5),
              120px 30px 100px rgba(255,255,255,0.4);
  animation:fluttuare 6s ease-in-out infinite alternate;
  z-index:2;
}
@keyframes fluttuare{from{transform:translateY(0)}to{transform:translateY(8px)}}

/* üöÅ Elicottero + scia */
#helicopter{
  position:absolute;
  top:25%;
  left:-180px;
  width:130px;
  height:70px;
  z-index:6;
  opacity:0.96;
  filter:drop-shadow(0 0 8px rgba(0,0,0,0.7));
  transition:transform 2s ease-out,left 25s linear;
}
#helicopter svg{width:100%;height:100%;display:block;}
#helicopter path{fill:#111;stroke:#666;stroke-width:8;}
.trail{
  position:absolute;
  height:4px;
  background:linear-gradient(90deg,rgba(255,255,255,0.65),rgba(255,255,255,0));
  border-radius:3px;
  z-index:4;
  opacity:0.4;
  pointer-events:none;
}

/* üê¶ Uccelli */
.bird{
  position:absolute;width:32px;height:24px;
  background:url('https://upload.wikimedia.org/wikipedia/commons/6/6b/Bird_silhouette.svg') no-repeat center/contain;
  opacity:0.85;z-index:3;animation:birdFlap 1.2s infinite;
}
@keyframes birdFlap{0%,100%{transform:translateY(0) scale(1);}50%{transform:translateY(-4px) scale(1.05);}}

/* üå´Ô∏è Banner AQI */
#ariaAlert{
  display:block;margin:18px auto 10px auto;padding:10px 32px;
  border-radius:22px;font-size:1.35em;font-weight:700;color:#fff;
  background:#00e400;box-shadow:0 0 25px rgba(0,255,0,0.5);
  width:fit-content;transition:all 0.8s ease;animation:none;z-index:5;text-align:center;
}
@keyframes blinkAir{from{opacity:0.6;}to{opacity:1;}}
@keyframes pulseDanger{0%,100%{box-shadow:0 0 25px 8px rgba(102,0,153,0.8);}50%{box-shadow:0 0 40px 16px rgba(255,0,255,0.7);}}

/* ‚òÄÔ∏è Barra Alba/Tramonto */
#sunMoonTimes{
  display:block;margin:0 auto 14px auto;font-size:1em;color:#000;
  background:rgba(255,255,255,0.65);padding:5px 14px;border-radius:12px;
  box-shadow:0 0 6px rgba(0,0,0,0.25);font-weight:600;width:fit-content;text-align:center;
}

/* üß≠ Gauges */
#gauges{
  display:flex;flex-wrap:wrap;justify-content:center;gap:22px;
  padding:20px 0 30px;background:linear-gradient(to bottom,#002850,#00142c);
  border-top:3px solid #004b8d;
}
.gaugeBox{
  background:linear-gradient(to bottom,#f8fbff,#e6edf5);
  border-radius:16px;width:230px;height:235px;padding:8px;
  color:#003366;box-shadow:0 0 10px rgba(0,0,0,0.14);position:relative;
}
.gaugeBox img{position:absolute;top:8px;right:8px;width:34px;opacity:0.84;}
.label{font-size:1.05em;font-weight:600;margin-top:6px;}

/* SEZIONE VENTO (GRAFICO + BANDIERA) */
#windSection{
  background:linear-gradient(to bottom,#00142c,#000814);
  padding:20px 10px 30px;
  border-top:2px solid #003060;
}
#windSection h2{
  margin:6px 0 10px;
  font-size:1.3em;
}
#windVisuals{
  display:flex;
  flex-wrap:wrap;
  justify-content:center;
  align-items:flex-start;
  gap:24px;
  max-width:900px;
  margin:0 auto;
}
#flagContainer{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:10px;
}
#flagpole{
  width:6px;
  height:120px;
  background:linear-gradient(to bottom,#ddd,#999);
  box-shadow:0 0 6px rgba(0,0,0,0.6);
  border-radius:3px;
}
#flag{
  width:110px;
  height:60px;
  margin-left:6px;
  background:linear-gradient(135deg,#ff1744,#ff9100,#ffea00);
  border-radius:4px 14px 14px 4px;
  box-shadow:0 0 12px rgba(0,0,0,0.5);
  transform-origin:left center;
}

/* diversi stati del vento */
.flag-calm{
  animation:flagWaveSmall 2.4s ease-in-out infinite;
}
.flag-breeze{
  animation:flagWaveSmall 1.7s ease-in-out infinite;
}
.flag-windy{
  animation:flagWaveMedium 1.1s ease-in-out infinite;
}
.flag-storm{
  animation:flagWaveStrong 0.6s ease-in-out infinite;
}

@keyframes flagWaveSmall{
  0%{transform:skewX(0deg) translateX(0);}
  50%{transform:skewX(-4deg) translateX(7px);}
  100%{transform:skewX(0deg) translateX(0);}
}
@keyframes flagWaveMedium{
  0%{transform:skewX(0deg) translateX(0);}
  50%{transform:skewX(-8deg) translateX(14px);}
  100%{transform:skewX(0deg) translateX(0);}
}
@keyframes flagWaveStrong{
  0%{transform:skewX(0deg) translateX(0);}
  50%{transform:skewX(-14deg) translateX(22px);}
  100%{transform:skewX(0deg) translateX(0);}
}

/* box grafico vento */
#windChartBox{
  background:rgba(0,0,0,0.35);
  border-radius:16px;
  padding:12px 10px 18px;
  box-shadow:0 0 10px rgba(0,0,0,0.6);
  min-width:260px;
  max-width:480px;
}
#windChart{
  width:100%;
  height:180px;
}

/* testo sotto bandiera */
#windLegend{
  font-size:0.93em;
  color:#a9c9ff;
}

/* FOOTER */
footer{
  font-size:0.9em;
  color:#a9c9ff;
  background:#001b3a;
  padding:10px;
}

@media (max-width:768px){
  #gauges{gap:18px;}
  .gaugeBox{width:45%;height:220px;padding:6px;}
}
@media (max-width:480px){
  #gauges{flex-direction:column;align-items:center;}
  .gaugeBox{width:85%;height:210px;}
  #ariaAlert{font-size:1.1em;padding:8px 20px;}
  #windVisuals{flex-direction:column;align-items:center;}
}
</style>
</head>
<body>

<header>üå§Ô∏è <span class="mainTitle">Langini Meteo ‚Äì Dashboard V13</span>
<span class="subTitle">ThingSpeak + Vento Pro</span></header>

<div id="statusBar">Caricamento dati...</div>

<div id="sky">
  <div id="stars"></div>
  <div id="sun"></div>
  <div id="moon"></div>

  <div id="helicopter">
    <svg viewBox="0 0 640 512" xmlns="http://www.w3.org/2000/svg">
      <path fill="#111" stroke="#666" stroke-width="8"
        d="M528 224H448v-48c0-26.5-21.5-48-48-48H288V96h48c8.8 0 16-7.2 16-16s-7.2-16-16-16H80c-8.8 0-16 7.2-16 16s7.2 16 16 16h80v32h-16c-26.5 0-48 21.5-48 48v96h-8c-17.7 0-32 14.3-32 32v32h32l32 64h32l32-64h64l32 64h32l32-64h32l32 64h32l32-64h32v-32h-16v-48h80v48h-16v32h48c8.8 0 16-7.2 16-16v-64c0-8.8-7.2-16-16-16zM112 176h320v48H112v-48zm320 192H208l-24-48h272l-24 48z"/>
      <rect x="260" y="58" width="120" height="6" fill="#222" stroke="#666" stroke-width="2">
        <animateTransform attributeName="transform" attributeType="XML"
          type="rotate" from="0 320 60" to="360 320 60" dur="0.25s" repeatCount="indefinite"/>
      </rect>
    </svg>
  </div>
</div>

<div id="ariaAlert">üåø Aria eccellente</div>
<div id="sunMoonTimes">‚òÄÔ∏è Alba: --:-- ‚Ä¢ üåá Tramonto: --:--</div>

<!-- GAUGES PRINCIPALI -->
<div id="gauges">
  <div class="gaugeBox">
    <img src="https://img.icons8.com/fluency/48/barometer.png">
    <div id="g1" style="height:130px"></div>
    <div class="label">Pressione (hPa)</div>
  </div>

  <div class="gaugeBox">
    <img src="https://img.icons8.com/fluency/48/temperature.png">
    <div id="g2" style="height:130px"></div>
    <div class="label">Temperatura (¬∞C)</div>
  </div>

  <div class="gaugeBox">
    <img src="https://img.icons8.com/fluency/48/hygrometer.png">
    <div id="g3" style="height:130px"></div>
    <div class="label">Umidit√† (%)</div>
  </div>

  <div class="gaugeBox">
    <img src="https://img.icons8.com/fluency/48/smelling.png">
    <div id="g4" style="height:130px"></div>
    <div class="label">Qualit√† Aria (AQI)</div>
  </div>

  <!-- NUOVO GAUGE VENTO -->
  <div class="gaugeBox">
    <img src="https://img.icons8.com/fluency/48/wind.png">
    <div id="g5" style="height:130px"></div>
    <div class="label">Vento (km/h)</div>
  </div>
</div>

<!-- SEZIONE VENTO (GRAFICO + BANDIERA) -->
<section id="windSection">
  <h2>üí® Vento ‚Äì Andamento & Intensit√†</h2>
  <div id="windVisuals">
    <div id="flagContainer">
      <div style="display:flex;align-items:flex-start;">
        <div id="flagpole"></div>
        <div id="flag" class="flag-calm"></div>
      </div>
      <div id="windLegend">La bandiera sventola in base alla velocit√† del vento.</div>
    </div>

    <div id="windChartBox">
      <h3>Andamento vento (ultime letture)</h3>
      <div id="windChart"></div>
    </div>
  </div>
</section>

<footer>¬© 2025 Langini Meteo ‚Ä¢ Dashboard V13 ThingSpeak + Vento Pro</footer>
<script>
/* ========= CONFIG ========= */
const LAT=45.77, LON=8.88;
const CHANNEL_ID = 3149218;

/* ========= GAUGES ========= */
const g1=new JustGage({id:"g1",value:0,min:950,max:1050,pointer:true});
const g2=new JustGage({id:"g2",value:0,min:-10,max:50,pointer:true});
const g3=new JustGage({id:"g3",value:0,min:0,max:100,pointer:true});
const g4=new JustGage({id:"g4",value:0,min:0,max:500,pointer:true});
const g5=new JustGage({
  id:"g5",
  value:0,
  min:0,
  max:120,
  decimals:1,
  pointer:true,
  gaugeWidthScale:0.8,
  customSectors:[
    { color:"#00e676", lo:0,  hi:15 },
    { color:"#29b6f6", lo:15, hi:30 },
    { color:"#ffeb3b", lo:30, hi:55 },
    { color:"#ff9800", lo:55, hi:75 },
    { color:"#e53935", lo:75, hi:120 }
  ],
  counter:true
});

/* ========= VARIABILI GRAFICO VENTO ========= */
let windPaper = null;
let windLine  = null;
let windAxis  = null;

/* ========= ANIMAZIONI CIELO ========= */
function creaNuvola(){
  const sky=document.getElementById("sky");
  const c=document.createElement("div");
  c.className="cloud";
  const s=0.8+Math.random()*1.4;
  c.style.width=(80+Math.random()*160)*s+"px";
  c.style.height=(35+Math.random()*45)*s+"px";
  c.style.top=(10+Math.random()*60)+"%";
  c.style.left="-250px";
  c.style.opacity=0.4+Math.random()*0.4;
  sky.appendChild(c);
  const dur=30000+Math.random()*40000;
  c.animate(
    [{transform:"translateX(0)"},{transform:`translateX(${window.innerWidth+400}px)`}],
    {duration:dur,easing:"linear"}
  ).onfinish=()=>{c.remove();setTimeout(creaNuvola,4000+Math.random()*3000);};
}

function volaElicottero(){
  const sky=document.getElementById('sky');
  const heli=document.getElementById('helicopter');
  const topPos=25+Math.random()*35;

  heli.style.top=topPos+'%';
  heli.style.left='-180px';
  heli.style.transition='none';
  heli.offsetHeight;

  const tilt=Math.random()>0.5?6:-6;
  heli.style.transform=`rotate(${tilt}deg)`;
  setTimeout(()=>heli.style.transform='rotate(0deg)',22000);

  heli.style.transition='transform 2s ease-out,left 25s linear';
  heli.style.left='110%';

  const trail=document.createElement('div');
  trail.className='trail';
  trail.style.top=`calc(${topPos}% + 25px)`;
  trail.style.left='-180px';
  trail.style.width='0px';
  sky.appendChild(trail);

  trail.animate(
    [{width:'0px',opacity:0.8},{width:window.innerWidth+'px',opacity:0.1}],
    {duration:25000,easing:'linear'}
  ).onfinish=()=>trail.remove();

  setTimeout(volaElicottero,35000+Math.random()*40000);
}

function creaUccello(){
  const sky=document.getElementById("sky");
  const b=document.createElement("div");
  b.className="bird";
  b.style.top=(20+Math.random()*50)+"%";
  b.style.left="-60px";
  b.style.transform=`scale(${0.7+Math.random()*0.6})`;
  sky.appendChild(b);

  const dur=15000+Math.random()*12000;
  b.animate(
    [{transform:"translateX(0)"},{transform:`translateX(${window.innerWidth+200}px)`}],
    {duration:dur,easing:"linear"}
  ).onfinish=()=>{b.remove();setTimeout(creaUccello,4000+Math.random()*7000);};
}

function aggiornaCielo(){
  const now=new Date(),t=SunCalc.getTimes(now,LAT,LON);
  const alba=t.sunrise.getHours()*60+t.sunrise.getMinutes();
  const tram=t.sunset.getHours()*60+t.sunset.getMinutes();
  const curr=now.getHours()*60+now.getMinutes();

  const sun=document.getElementById("sun"),
        moon=document.getElementById("moon"),
        stars=document.getElementById("stars");

  document.getElementById("sunMoonTimes").innerHTML=
    `‚òÄÔ∏è Alba: ${String(t.sunrise.getHours()).padStart(2,"0")}:${String(t.sunrise.getMinutes()).padStart(2,"0")}
     ‚Ä¢ üåá Tramonto: ${String(t.sunset.getHours()).padStart(2,"0")}:${String(t.sunset.getMinutes()).padStart(2,"0")}`;

  if(curr>=alba && curr<tram){
    stars.style.opacity=0;
    sun.style.opacity=1;
    moon.style.opacity=0;

    const p=(curr-alba)/(tram-alba);
    sun.style.left=5+p*90+"%";
    sun.style.top=53-17*Math.sin(p*Math.PI)+"%";

  } else {
    stars.style.opacity=0.9;
    moon.style.opacity=1;
    sun.style.opacity=0;

    const tot=(24*60-tram)+alba;
    const pass=curr>=tram?(curr-tram):(curr+24*60-tram);
    const p=pass/tot;

    moon.style.left=95-p*90+"%";
    moon.style.top=53-12*Math.sin(p*Math.PI)+"%";
  }
}

function initCielo(){
  for(let i=0;i<40;i++){
    let e=document.createElement('div');
    e.className='star';
    e.style.left=Math.random()*100+'%';
    e.style.top=Math.random()*100+'%';
    e.style.animationDelay=Math.random()*3+'s';
    document.getElementById('stars').appendChild(e);
  }

  for(let i=0;i<5;i++)
    setTimeout(creaNuvola,Math.random()*6000);

  for(let i=0;i<3;i++)
    setTimeout(creaUccello,Math.random()*8000);

  volaElicottero();
  aggiornaCielo();
  setInterval(aggiornaCielo,60000);
}
document.addEventListener("DOMContentLoaded",initCielo);

/* ========= DISEGNO GRAFICO VENTO (RAPHAEL) ========= */
function disegnaGraficoVento(valori){
  const el = document.getElementById("windChart");
  if(!el) return;

  const w = el.clientWidth || 320;
  const h = el.clientHeight || 180;

  if(!windPaper){
    windPaper = Raphael("windChart", w, h);
  }else{
    windPaper.setSize(w,h);
    windPaper.clear();
  }

  const v = valori.filter(x => !isNaN(x));
  if(!v.length) return;

  const maxV = Math.max(...v, 5);
  const minV = 0;
  const span = maxV - minV || 1;

  const leftPad = 30;
  const rightPad = 10;
  const topPad = 10;
  const bottomPad = 20;

  const usableW = w - leftPad - rightPad;
  const usableH = h - topPad - bottomPad;

  const n = valori.length;
  let path = "";

  for(let i=0;i<n;i++){
    const val = isNaN(valori[i]) ? minV : valori[i];
    const x = leftPad + (i/(n-1 || 1))*usableW;
    const y = topPad + (1 - (val-minV)/span)*usableH;

    if(i===0) path += `M${x},${y}`;
    else path += `L${x},${y}`;
  }

  // griglia base
  const axisColor = "#88c";
  windPaper.path(`M${leftPad},${topPad}L${leftPad},${h-bottomPad}`).attr({stroke:axisColor,"stroke-width":1});
  windPaper.path(`M${leftPad},${h-bottomPad}L${w-rightPad},${h-bottomPad}`).attr({stroke:axisColor,"stroke-width":1});
  // label max e min
  windPaper.text(10, topPad+5, `${maxV.toFixed(1)} km/h`).attr({"font-size":10,fill:"#a9c9ff","text-anchor":"start"});
  windPaper.text(10, h-bottomPad, "0 km/h").attr({"font-size":10,fill:"#a9c9ff","text-anchor":"start"});

  // linea vento
  windPaper.path(path).attr({
    stroke:"#29b6f6",
    "stroke-width":3,
    "stroke-linejoin":"round",
    "stroke-linecap":"round"
  });

  // riempimento morbido
  const lastSeg = path.replace("M","L");
  windPaper.path(path + `L${leftPad+usableW},${h-bottomPad}L${leftPad},${h-bottomPad}Z`).attr({
    stroke:"none",
    fill:"90-#29b6f655-#001b3a00"
  });
}

/* ========= AGGIORNAMENTO DATI THINGSPEAK ========= */
async function aggiorna(){
  try{
    const r = await fetch(`https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds.json?results=60`);
    const d = await r.json();

    if(!d.feeds || !d.feeds.length) return;

    const f = d.feeds.map(e => ({
      p : +e.field1,   // pressione
      t : +e.field2,   // temperatura
      h : +e.field3,   // umidit√†
      a : +e.field4,   // aqi
      v : +e.field5,   // vento
      pi: +e.field6    // pioggia (0/1)
    }));
    const u = f.at(-1);

    // Aggiorna gauge
    g1.refresh(u.p);
    g2.refresh(u.t);
    g3.refresh(u.h);
    g4.refresh(u.a);
    g5.refresh(u.v);

    // Grafico vento con tutti i valori v
    const serieVento = f.map(x => x.v);
    disegnaGraficoVento(serieVento);

    // Banner AQI
    const alert=document.getElementById("ariaAlert");
    let aqi=u.a, text="--", bg="#00e400", anim="none";

    if(aqi<=50){text="üåø Aria eccellente";bg="#00e400";}
    else if(aqi<=100){text="üòä Aria buona";bg="#9cff00";}
    else if(aqi<=150){text="‚ö†Ô∏è Qualit√† moderata";bg="#ffde33";anim="blinkAir 1.4s infinite alternate";}
    else if(aqi<=200){text="üò∑ Aria scadente";bg="#ff9933";}
    else if(aqi<=300){text="‚ò†Ô∏è Aria molto scarsa";bg="#cc0033";}
    else{text="üíÄ Aria pericolosa";bg="#660099";anim="pulseDanger 2.5s infinite alternate";}

    alert.textContent=text;
    alert.style.background=bg;
    alert.style.boxShadow=`0 0 25px ${bg}`;
    alert.style.animation=anim;

    // Barra stato + colore in base al vento
    const status = document.getElementById("statusBar");
    status.textContent =
      `‚úî Aggiornato alle ${new Date().toLocaleTimeString("it-IT")} ‚Ä¢ üí® ${u.v.toFixed(1)} km/h ‚Ä¢ ‚òÅ ${u.pi ? "Pioggia" : "Asciutto"}`;

    let windColor = "#a9c9ff";
    if(u.v > 15) windColor = "#29b6f6";
    if(u.v > 30) windColor = "#ffeb3b";
    if(u.v > 55) windColor = "#ff9800";
    if(u.v > 75) windColor = "#e53935";
    status.style.color = windColor;

    // Bandiera animata in base al vento
    const flag = document.getElementById("flag");
    flag.className = ""; // reset
    if(u.v < 5)       flag.classList.add("flag-calm");
    else if(u.v < 20) flag.classList.add("flag-breeze");
    else if(u.v < 50) flag.classList.add("flag-windy");
    else              flag.classList.add("flag-storm");

  }catch(err){
    document.getElementById("statusBar").textContent="‚ö† Errore connessione ThingSpeak";
  }
}

setInterval(aggiorna,30000);
aggiorna();
</script>

</body>
</html>
